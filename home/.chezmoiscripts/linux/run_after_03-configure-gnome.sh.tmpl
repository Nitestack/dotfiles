#!/bin/bash

# {{ template "bash-library.sh" . }}

# The following line is for ShellCheck to correctly identify the above included library
true || source "../../.chezmoitemplates/bash-library.sh"

function gsettings_ensure() {
	local schema="$1"
	local key="$2"
	local value="$3"
	local extension="${4:-}"

	local first_args=()
	if [[ -n "${extension}" ]]; then
		first_args+=(--schemadir "${XDG_DATA_HOME:-${HOME}/.local/share}/gnome-shell/extensions/${extension}/schemas")
	fi

	local current_value
	current_value="$(gsettings "${first_args[@]}" get "${schema}" "${key}")"

	if [[ "${current_value}" != "${value}" && "${current_value}" != "'${value}'" ]]; then
		gsettings "${first_args[@]}" set "${schema}" "${key}" "${value}"
	fi
}

if [[ "${DESKTOP_SESSION:-}" == "gnome" ]]; then
	configure_gnome() {
		# Setup VS Code as default text editor on GNOME
		xdg-mime default code.desktop text/plain

		# Configure Calculator
		gsettings_ensure org.gnome.calculator show-thousands true

		# Configure Console
		gsettings_ensure org.gnome.Console custom-font "{{- .font.nerd.family }} {{ .font.size -}}"

		# Configure Contacts
		gsettings_ensure org.gnome.Contacts sort-on-surname true

		# Configure Text Editor
		gsettings_ensure org.gnome.TextEditor custom-font "{{- .font.nerd.family }} {{ .font.size -}}"
		gsettings_ensure org.gnome.TextEditor highlight-current-line true
		gsettings_ensure org.gnome.TextEditor indent-style "space"
		gsettings_ensure org.gnome.TextEditor indent-width "2"
		gsettings_ensure org.gnome.TextEditor keybindings "vim"
		gsettings_ensure org.gnome.TextEditor show-line-numbers true

		# Configure File Chooser
		gsettings_ensure org.gtk.gtk4.Settings.FileChooser show-hidden true
		gsettings_ensure org.gtk.gtk4.Settings.FileChooser show-type-column true
	}

	show_spinner "configure_gnome" "Linux: Configuring GNOME" "Linux: GNOME configured"
fi
