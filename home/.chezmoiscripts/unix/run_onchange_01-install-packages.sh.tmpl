#!/bin/bash

# {{ template "bash-library.sh" . }}

# Install packages
# {{ if eq .osid "linux-arch" }}
log_task "Arch Linux: Installing packages"
echo
sudo pacman -Syu

echo
log_task "pacman:"
# {{ range $_, $package_name := concat .dependencies.arch.pacman .dependencies.unix.packages .dependencies.all.packages }}
pacman_ensure_installed "{{- $package_name -}}"
# {{ end }}

# {{ else if eq .osid "linux-ubuntu" }}
log_task "Ubuntu: Installing packages"
echo
sudo apt update -y && sudo apt upgrade -y

echo
log_task "apt:"
# {{ range $_, $package_name := concat .dependencies.ubuntu.apt .dependencies.unix.packages .dependencies.all.packages }}
apt_ensure_installed "{{- $package_name -}}"
# {{ end }}

# {{ else if eq .chezmoi.os "darwin" }}
log_task "macOS: Installing formulae and casks"
echo
brew update && brew upgrade

echo
log_tasks "brew (formulae):"
# {{ range $_, $formula := concat .dependencies.macos.brew.formulae .dependencies.unix.packages .dependencies.all.packages }}
brew_ensure_formula_installed "{{- $formula -}}"
# {{ end }}

echo
log_tasks "brew (casks):"
# {{ range $_, $cask := concat .dependencies.macos.brew.casks }}
brew_ensure_cask_installed "{{- $cask -}}"
# {{ end }}

# {{ end }}

# NVM
echo
log_task "Custom installation:"
if [[ -d "${NVM_DIR:-"~/.nvm"}/.git" ]]; then
	log_info "'nvm' is already installed. Skipping."
else
	curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh | bash
	[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm
fi

# Custom installation
# {{ if eq .osid "linux-arch" }}
# {{ range $_, $pkg := concat .dependencies.arch.custom .dependencies.unix.custom .dependencies.all.custom }}
# {{ range $cmd_name, $to_install := $pkg }}
if command -v "{{- $cmd_name -}}" >/dev/null 2>&1; then
	log_info "{{- $cmd_name | squote }} is already installed. Skipping."
else
	log_task "Installing {{ $cmd_name | squote -}}"
	# {{ range $_, $line := $to_install }}
	# {{ "\n" }} command_exec {{ $line }}
	# {{ end }}
fi
# {{ end }}
# {{ end }}

# {{ else if eq .osid "linux-ubuntu" }}
# {{ range $_, $pkg := concat .dependencies.ubuntu.custom .dependencies.unix.custom .dependencies.all.custom }}
# {{ range $cmd_name, $to_install := $pkg }}
if command -v "{{- $cmd_name -}}" >/dev/null 2>&1; then
	log_info "{{- $cmd_name | squote }} is already installed. Skipping."
else
	log_task "Installing {{ $cmd_name | squote -}}"
	# {{ range $_, $line := $to_install }}
	# {{ "\n" }} command_exec {{ $line }}
	# {{ end }}
fi
# {{ end }}
# {{ end }}

# {{ else if eq .chezmoi.os "darwin" }}
# {{ range $_, $pkg := concat .dependencies.macos.custom .dependencies.unix.custom .dependencies.all.custom }}
# {{ range $cmd_name, $to_install := $pkg }}
if command -v "{{- $cmd_name -}}" >/dev/null 2>&1; then
	log_info "{{- $cmd_name | squote }} is already installed. Skipping."
else
	log_task "Installing {{ $cmd_name | squote -}}"
	# {{ range $_, $line := $to_install }}
	# {{ "\n" }} command_exec {{ $line }}
	# {{ end }}
fi
# {{ end }}
# {{ end }}

# {{ end }}

# Global npm packages
echo
log_task "npm:"
# {{ range $_, $package_name := .dependencies.all.pnpm }}
if pnpm list -g --depth 0 | grep -q "{{- $package_name -}}"; then
	log_info "pnpm: package {{ $package_name | squote }} is already installed. Skipping."
else
	log_task "Installing package {{ $package_name | squote }} via pnpm"
	command_exec pnpm add -g "{{- $package_name -}}"
fi
# {{ end }}

# Global cargo crates
echo
log_task "cargo:"
# {{ range $_, $package_name := .dependencies.all.cargo }}
if cargo install --list | grep -q "{{- $package_name -}}"; then
	log_info "cargo: crate {{ $package_name | squote }} is already installed. Skipping."
else
	log_task "Installing crate {{ $package_name | squote }} via cargo"
	command_exec cargo install "{{- $package_name -}}"
fi
# {{ end }}
