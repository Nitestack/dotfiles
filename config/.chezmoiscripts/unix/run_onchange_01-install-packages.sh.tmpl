#!/usr/bin/env bash

# {{ template "bash-library.sh" . }}

# The following line is for ShellCheck to correctly identify the above included library
true || source "../../.chezmoitemplates/bash-library.sh"

# ╭──────────────────────────────────────────────────────────╮
# │ Note: Any brew related packages for macOS are handled    │
# │ already, check the custom mac scripts                    │
# ╰──────────────────────────────────────────────────────────╯

# ╭──────────────────────────────────────────────────────────╮
# │ Install essentials                                       │
# ╰──────────────────────────────────────────────────────────╯
_log_header "Essential Packages"

# {{ $osid := .osid }}
# {{ $os := .chezmoi.os }}
# {{ $essentialCustomPackages := list }}
# {{ range .packages.essentials }}
#   {{ if and (eq $os "darwin") (and (hasKey . "mac") (hasKey .mac "custom")) }}
#     {{ $essentialCustomPackages = mustAppend $essentialCustomPackages (dict .name .mac.custom) }}
#   {{ else if hasKey . "custom" }}
#     {{ $essentialCustomPackages = mustAppend $essentialCustomPackages (dict .name .custom) }}
#   {{ end }}
# {{ end }}

# ── custom ────────────────────────────────────────────────────────────
gum format -- "## custom:"
# {{ range $essentialCustomPackages }}
# {{ range $cmd_name, $lines := . }}
if command -v "{{- $cmd_name -}}" &>/dev/null; then
	_log -l warn "{{- $cmd_name }} is already installed"
else
	# {{ "\n" }} {{ $lines }}
	_log -l info "Installed {{ $cmd_name -}}"
fi
# {{ end }}
# {{ end }}

# ── volta ─────────────────────────────────────────────────────────────
gum format -- "## volta:"
volta_list=$(volta list --format plain)
# {{ range (.packages.volta | uniq) }}
if echo "${volta_list}" | grep -q "{{- . -}}"; then
	_log -l warn --prefix "volta" "{{- . }} is already installed"
else
	volta install "{{- . -}}"
	_log -l info --prefix "volta" "Installed {{ . -}}"
fi
# {{ end }}

echo
_log -l info "Installed essential packages"

# ╭──────────────────────────────────────────────────────────╮
# │ Install packages                                         │
# ╰──────────────────────────────────────────────────────────╯
_log_header "Packages"

# {{ $customPackages := list }}
# {{ range .packages.common }}
#   {{ if and (eq $os "darwin") (and (hasKey . "mac") (hasKey .mac "custom")) }}
#     {{ $customPackages = mustAppend $customPackages (dict .name .mac.custom) }}
#   {{ else if hasKey . "custom" }}
#     {{ $customPackages = mustAppend $customPackages (dict .name .custom) }}
#   {{ end }}
# {{ end }}

# ── custom ────────────────────────────────────────────────────────────
gum format -- "## custom:"
# {{ range $customPackages }}
# {{ range $cmd_name, $lines := . }}
if command -v "{{- $cmd_name -}}" &>/dev/null; then
	_log -l warn "{{- $cmd_name }} is already installed"
else
	# {{ "\n" }} {{ $lines }}
	_log -l info "Installed {{ $cmd_name -}}"
fi
# {{ end }}
# {{ end }}

# ── pnpm ──────────────────────────────────────────────────────────────
gum format -- "## pnpm:"
pnpm_list=$(pnpm list -g --depth 0)
# {{ range (.packages.npm | uniq | sortAlpha) }}
if echo "${pnpm_list}" | grep -q "{{- . -}}"; then
	_log -l warn --prefix "pnpm" "{{- . }} is already installed"
else
	pnpm add -g "{{- . -}}"
	_log -l info --prefix "pnpm" "Installed {{ . -}}"
fi
# {{ end }}

# ── cargo ─────────────────────────────────────────────────────────────
gum format -- "## cargo:"
cargo_list=$(cargo install --list)
# {{ range (.packages.cargo | uniq | sortAlpha) }}
if echo "${cargo_list}" | grep -q "{{- . -}}"; then
	_log -l warn --prefix "cargo" "{{- . }} is already installed"
else
	cargo install "{{- . -}}"
	_log -l info --prefix "cargo" "Installed {{ . -}}"
fi
# {{ end }}

echo
_log -l info "Installed packages"
